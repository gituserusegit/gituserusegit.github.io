

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="​		本文主要总结了HAproxy的常用配置，提供了HAproxy使用案例。">
<meta property="og:type" content="article">
<meta property="og:title" content="HAproxy配置总结">
<meta property="og:url" content="http://example.com/2022/08/09/HAproxy%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="DXL&#39;s blog">
<meta property="og:description" content="​		本文主要总结了HAproxy的常用配置，提供了HAproxy使用案例。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-08-09T18:37:40.000Z">
<meta property="article:modified_time" content="2022-12-13T08:18:23.204Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="HAproxy">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>HAproxy配置总结 - DXL&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Linux</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="HAproxy配置总结">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-08-09 18:37" pubdate>
        August 9, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      13k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      109 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">HAproxy配置总结</h1>
            
            <div class="markdown-body">
              <p>​		本文主要总结了HAproxy的常用配置，提供了HAproxy使用案例。</p>
<span id="more"></span>

<h1 id="HAproxy简介"><a href="#HAproxy简介" class="headerlink" title="HAproxy简介"></a>HAproxy简介</h1><p>​		HAProxy，high available proxy，是具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计。</p>
<p>​		官方文档<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/">http://cbonte.github.io/haproxy-dconv/</a></p>
<p>​					   <a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html</a></p>
<p>主要功能：</p>
<ul>
<li>TCP 和 HTTP反向代理</li>
<li>SSL&#x2F;TSL服务器</li>
<li>可以针对HTTP请求添加cookie，进行路由后端服务器</li>
<li>可平衡负载至后端服务器，并支持持久连接</li>
<li>支持所有主服务器故障切换至备用服务器</li>
<li>支持专用端口实现监控服务</li>
<li>支持停止接受新连接请求，而不影响现有连接</li>
<li>可以在双向添加，修改或删除HTTP报文首部</li>
<li>响应报文压缩</li>
<li>支持基于pattern实现连接请求的访问控制</li>
<li>通过特定的URI为授权用户提供详细的状态信息</li>
</ul>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>​		Lua环境：需要先编译安装lua（自带版本较旧），源码包 <a target="_blank" rel="noopener" href="http://www.lua.org/ftp/%E9%9C%80%E8%A6%81%E5%89%8D%E7%BD%AEgcc">http://www.lua.org/ftp/需要前置gcc</a> 	readline-devel，解包后到目录下执行make linux test。</p>
<p>​		HAproxy需要前置 gcc 	openssl-devel 	pcre-devel 	systemd-devel 。解包后可在目录下查看帮助文件README和INSTALL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">参考文档进行安装</span><br>make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_LUA=1 LUA_INC=/usr/local/src/lua-5.3.5/src/ LUA_LIB=/usr/local/src/lua-5.3.5/src/<br><br>make install PREFIX=/apps/haproxy<br><br>ln -s /apps/haproxy/sbin/haproxy /usr/sbin/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在/usr/lib/systemd/system/下准备启动文件</span><br>[Unit]<br>Description=HAProxy Load Balancer<br>After=syslog.target network.target<br>[Service]<br>ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q<br>ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p<br>/var/lib/haproxy/haproxy.pid<br>ExecReload=/bin/kill -USR2 $MAINPID<br>LimitNOFILE=100000<br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">准备socket文件目录</span><br>mkdir /var/lib/haproxy<br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置用户和目录权限</span><br>useradd -r -s /sbin/nologin -d /var/lib/haproxy haproxy<br>systemctl enable --now haproxy<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">访问状态页</span><br>http://HAproxy主机的IP:9999/haproxy-status<br></code></pre></td></tr></table></figure>

<h1 id="HAproxy配置详解"><a href="#HAproxy配置详解" class="headerlink" title="HAproxy配置详解"></a>HAproxy配置详解</h1><p>​		目录&#x2F;usr&#x2F;local&#x2F;src&#x2F;haproxy-2.1.3&#x2F;examples&#x2F;下有配置文件的范例可供学习</p>
<p>​		HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分。</p>
<p>​		global：全局配置段，其中定义了进程及安全配置相关的参数，性能调整相关参数和Debug参数。</p>
<p>​		proxies：代理配置段，可分为四大模块，其中defaults部分为frontend, backend, listen提供默认配置；frontend配置前端，相当于nginx中的server {}块；backend配置后端，相当于nginx中的upstream {}块；listen：同时拥有前端和后端配置,配置简单,生产推荐使用。</p>
<h3 id="global配置参数"><a href="#global配置参数" class="headerlink" title="global配置参数"></a>global配置参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">chroot #锁定运行目录<br>deamon #以守护进程运行<br>stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1 #socket文件<br>user, group, uid, gid  #运行haproxy的用户身份<br>nbproc   n #开启的haproxy worker 进程数，默认进程数是一个<br>nbthread 1 #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程<br>cpu-map 1 0   #绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU<br>cpu-map 2 1     #绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1号CPU<br>maxconn n   #每个haproxy进程的最大并发连接数<br>maxsslconn n   #每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下<br>maxconnrate n   #每个进程每秒创建的最大连接数量<br>spread-checks n #后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0<br>pidfile #指定pid文件路径<br>log 127.0.0.1 local2 info #定义全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个<br></code></pre></td></tr></table></figure>

<h3 id="proxies配置参数"><a href="#proxies配置参数" class="headerlink" title="proxies配置参数"></a>proxies配置参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell">option redispatch     #当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发<br>option abortonclose   #当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启<br>option http-keep-alive #开启与客户端的会话保持<br>option forwardfor     #透传客户端真实IP至后端web服务器<br>mode http|tcp #设置默认工作类型,使用TCP服务器性能更好，减少压力<br>timeout http-keep-alive 120s #session 会话保持超时时间，此时间段内会转发到相同的后端服务器<br>timeout connect 12s #客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms<br>timeout server 60s #客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些，访止502错误<br>timeout client 600s #设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同<br>timeout check   5s   #对后端服务器的默认检测超时时间<br>default-server inter 1000 weight 3   #指定后端服务器的默认设置<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">frontend 配置参数：</span><br>bind： #指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中<br>bind [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]#注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1<br>backlog &lt;backlog&gt; #针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注意：不支持backend<br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例</span><br>frontend magedu_web_port #可以采用后面形式命名：业务-服务-端口号<br>   bind :80,:8080<br>   bind 10.0.0.7:10080,:8801-8810,10.0.0.17:9001-9010<br>   mode http|tcp     #指定负载协议类型<br>   use_backend &lt;backend_name&gt;  #调用的后端服务器组名称<br>   <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">backend配置参数：</span><br>mode http|tcp  #指定负载协议类型,和对应的frontend必须一致<br>option #配置选项，可用于实现更多应用层检测功能。<br>server   #定义后端real server,必须指定IP和端口<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">server 配置</span><br>check #对指定real进行健康状态检查，如果不加此设置，默认不开启检查,只有check后面没有其它配置也可以启用检查功能<br> 	addr &lt;IP&gt;   #可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量<br> 	port &lt;num&gt; #指定的健康状态监测端口<br>	inter &lt;num&gt; #健康状态检查间隔时间，默认2000 ms<br> 	fall &lt;num&gt;   #后端服务器从线上转为下线的检查的连续失效次数，默认为3<br>	rise &lt;num&gt;   #后端服务器从下线恢复上线的检查的连续有效次数，默认为2<br>	weight &lt;weight&gt; #默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡，但仍接受持久连接<br>backup #将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似Sorry Server	<br>disabled #将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,状态为深黄色,优雅下线,不再接受新用户的请求<br>redirect prefix http://www.baidu.com/ #将请求临时(302)重定向至其它URL，只适用于http模式<br>redir http://www.baidu.com       #将请求临时(302)重定向至其它URL，只适用于http模式<br>maxconn &lt;maxconn&gt; #当前后端server的最大并发连接数<br>send-proxy	#IP透传，需要后端日志变量$proxy_protocol_addr显示<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：客户端访问10.0.0.7调度到后端两台服务器</span><br>frontend WEB_PORT_80<br>   bind 10.0.0.7:80<br>   mode http<br>   use_backend web_prot_http_nodes<br>backend web_prot_http_nodes<br>   mode http<br>   option forwardfor		#请求报文中添加首部字段，实现IP透传<br>   server 10.0.0.17 10.0.0.17:8080   check inter 3000 fall 3 rise 5  <br>   server 10.0.0.27 10.0.0.27:8080   check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="健康性检测"><a href="#健康性检测" class="headerlink" title="健康性检测"></a>健康性检测</h3><p>​		基于应用层http协议，采有不同的监测方式，对后端real server进行状态监测。</p>
<p>​		backend中的option参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">option httpchk   #启用七层健康性检测，对tcp 和 http 模式都支持，默认为：OPTIONS / HTTP/1.0<br>option httpchk &lt;uri&gt;<br>option httpchk &lt;method&gt; &lt;uri&gt;<br>option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">期望以上检查得到的响应码</span><br>http-check expect [!] &lt;match&gt; &lt;pattern&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：</span><br>http-check expect status 200	#响应码为200认为健康<br>http-check expect ! status ^5 #支持正则表达式<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例</span><br>listen web_host<br> bind 10.0.0.7:80<br> mode http<br> balance roundrobin<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">option httpchk GET /monitor/check.html <span class="hljs-comment">#默认HTTP/1.0</span></span><br><span class="hljs-meta prompt_">  #</span><span class="language-bash">option httpchk GET /monitor/check.html HTTP/1.0</span><br><span class="hljs-meta prompt_">  #</span><span class="language-bash">option httpchk GET /monitor/check.html HTTP/1.1   <span class="hljs-comment">#HTTP/1.1强制要求必须有Host字段</span></span><br> option httpchk HEAD /monitor/check.html HTTP/1.1\r\nHost:\ 10.0.0.7 #使用HEAD减少网络流量<br> server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5<br> server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5<br></code></pre></td></tr></table></figure>



<h3 id="启用状态页"><a href="#启用状态页" class="headerlink" title="启用状态页"></a>启用状态页</h3><p>​		相关配置选项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">stats enable   #基于默认的参数启用stats page<br>stats hide-version   #将状态页中haproxy版本隐藏<br>stats refresh &lt;delay&gt; #设定自动刷新时间间隔，默认不自动刷新,以秒为单位<br>stats uri &lt;prefix&gt; #自定义stats page uri，默认值：/haproxy?stats <br>stats realm &lt;realm&gt; #账户认证时的提示信息<br>stats auth &lt;user&gt;:&lt;passwd&gt; #认证时的账号和密码，可定义多个用户,每行指定一个用户.默认：no authentication<br>stats admin &#123; if | unless &#125; &lt;cond&gt; #启用stats page中的管理功能<br></code></pre></td></tr></table></figure>

<p>​		配置文件中启用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">listen haproxy-status<br> bind :9999<br> stats enable<br> stats uri /haproxy-status         #自定义stats page uri<br> stats realm HAProxy\ Stats\ Page     #账户认证时的提示信息<br> stats auth haadmin:123456   #两个用户<br> stats auth admin:123456<br> stats refresh 30<br> stats admin if TRUE #安全原因，不建议打开<br></code></pre></td></tr></table></figure>

<h3 id="HTTPS配置"><a href="#HTTPS配置" class="headerlink" title="HTTPS配置"></a>HTTPS配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置HAProxy支持https协议，支持ssl会话；</span><br>bind *:443 ssl crt /PATH/TO/SOME_PEM_FILE<br><span class="hljs-meta prompt_">#</span><span class="language-bash">指令 crt 后证书文件为PEM格式，需要同时包含证书和所有私钥</span> <br> cat demo.key demo.crt &gt; demo.pem<br><span class="hljs-meta prompt_">#</span><span class="language-bash">把80端口的请求重向定443</span><br> bind *:80<br> redirect scheme https if !&#123; ssl_fc &#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">向后端传递用户请求的协议和端口（frontend或backend）</span><br> http_request set-header X-Forwarded-Port %[dst_port]<br> http_request add-header X-Forwared-Proto https if &#123; ssl_fc &#125; <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例</span><br>frontend magedu_http_port<br> bind 10.0.0.7:80<br><span class="hljs-meta prompt_">#</span><span class="language-bash">添加https设置</span><br> bind 10.0.0.7:443 ssl crt /etc/haproxy/certs/haproxy.pem<br> redirect scheme https if !&#123; ssl_fc &#125;<br> http-request set-header X-forwarded-Port   %[dst_port]<br> http-request add-header X-forwarded-Proto https if &#123; ssl_fc &#125;<br> mode http<br> balance roundrobin<br></code></pre></td></tr></table></figure>



<h1 id="HAproxy调度"><a href="#HAproxy调度" class="headerlink" title="HAproxy调度"></a>HAproxy调度</h1><p>​		HAProxy通过固定参数 balance 指明对后端服务器的调度算法，该参数可以配置在listen或backend选</p>
<p>项中。HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转</p>
<p>换。调度算法与LVS中的类似。</p>
<h3 id="HAproxy常见调度算法"><a href="#HAproxy常见调度算法" class="headerlink" title="HAproxy常见调度算法"></a>HAproxy常见调度算法</h3><p>​		static-rr：基于权重的轮询调度，不支持运行时利用socat进行权重的动态调整(只支持0和1,不支持其它</p>
<p>值)及后端服务器慢启动，其后端主机数量没有限制，相当于LVS中的 wrr。</p>
<p>​		roundrobin：基于权重的轮询动态调度算法，支持权重的运行时调整，不同于lvs中的rr轮训模式，</p>
<p>支持慢启动，其每个后端backend中最多支持4095个RS，支持权重动态调整，roundrobin为默认调度算法。</p>
<p>​		leastconn ：加权的最少连接的动态，支持权重的运行时调整和慢启动，即:根据当前连接最少的后端服务</p>
<p>器而非权重进行优先调度(新客户端连接)，比较适合长连接的场景使用，比如MySQL场景。</p>
<p>​	   random：其基于随机数作为一致性hash的key负载平衡算法，随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持weight的动态调整，weight较大的主机有更大概率获取新请求。</p>
<p>​		source：源地址hash，基于用户源地址hash并将请求转发到后端服务器，后续同一个源地址请求将被转发至同一个后端web服务器。此方式当后端服务器数据量发生变化时，会导致很多用户的请求转发至新的后端服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">示例</span><br> listen web_host<br> bind 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010<br> mode http<br> balance roundrobin		#上述几种算法配置仅需在balance后指定<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">hashtype consistent	<span class="hljs-comment">#若采用source还需要指定hash类型，如一致性哈希算法、uri作哈希等</span></span><br> server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5<br> server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>



<h3 id="实用管理工具socat"><a href="#实用管理工具socat" class="headerlink" title="实用管理工具socat"></a>实用管理工具socat</h3><p>​		对服务器动态权重和其它状态可以利用 socat工具进行调整，Socat 是 Linux 下的一个多功能的网络工</p>
<p>具，名字来由是Socket CAT。主要特点就是在两个数据流之间建立双向通道，且支持众多协议和链接方式，如 IP、TCP、 UDP、IPv6、Socket文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">默认是交互式的，可以通过接受标准输入的方式执行命令</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改权重，注意只针对单进程有效</span><br>echo &quot;set weight magedu-test-80/web2 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock<br>echo &quot;get weight magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock         2 (initial 3)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">权重为0则下线</span><br>echo &quot;set weight magedu-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用禁用后端服务器</span><br>echo &quot;disable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock<br>echo &quot;enable server magedu-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">针对多进程需要在haproxy.cfg配置文件中进行绑定</span><br></code></pre></td></tr></table></figure>

<h3 id="ACL灵活调度原理"><a href="#ACL灵活调度原理" class="headerlink" title="ACL灵活调度原理"></a>ACL灵活调度原理</h3><p>​		访问控制列表Access Control Lists，是一种基于包过滤的访问控制技术，根据设定的条件对经过服务器传输的数据包进行过滤，基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作，比如允许其通过或丢弃。</p>
<p>​		还要很多预定义的acl，详见官方文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">格式</span><br>acl   &lt;aclname&gt; &lt;criterion&gt;   [flags]     [operator]   [&lt;value&gt;]<br>acl     名称     匹配规范     匹配模式     具体操作符     操作对象类型<br></code></pre></td></tr></table></figure>

<p><strong>criterion匹配规范</strong></p>
<p>​		可以理解为条件判断</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs shell">hdr string，提取在一个HTTP请求报文的首部<br>hdr（[&lt;name&gt; [，&lt;occ&gt;]]）#完全匹配字符串,header的指定信息，&lt;occ&gt; 表示在多值中使用的值的出现次数<br>hdr_beg（[&lt;name&gt; [，&lt;occ&gt;]]）#前缀匹配，header中指定匹配内容的开头<br>hdr_end（[&lt;name&gt; [，&lt;occ&gt;]]）#后缀匹配，header中指定匹配内容结尾<br>hdr_dom（[&lt;name&gt; [，&lt;occ&gt;]]）#域匹配，header中的域名<br>hdr_dir（[&lt;name&gt; [，&lt;occ&gt;]]）#路径匹配，header的uri路径<br>hdr_len（[&lt;name&gt; [，&lt;occ&gt;]]）#长度匹配，header的长度匹配<br>hdr_reg（[&lt;name&gt; [，&lt;occ&gt;]]）#正则表达式匹配，自定义表达式(regex)模糊匹配<br>hdr_sub（[&lt;name&gt; [，&lt;occ&gt;]]）#子串匹配，header中的uri模糊匹配<br><br>-i 不区分大小写<br>-m 使用指定的pattern匹配方法<br>整数比较：eq、ge、gt、le、lt<br>字符比较：<br>- exact match     (-m str) :字符串必须完全匹配模式<br>- substring match (-m sub) :在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配<br>- prefix match   (-m beg) :在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹配<br>- suffix match   (-m end) :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL进<br>行匹配<br>- subdir match   (-m dir) :查看提取出来的用斜线分隔&quot;/&quot;的字符串，如其中任一个匹配，则ACL进行匹配<br>- domain match   (-m dom) :查找提取的用点&quot;.&quot;分隔字符串，如果其中任何一个匹配，则ACL进行匹配<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：报文首部字段中浏览器为curl和wget则禁止访问</span><br>acl bad_agent hdr_sub(User-Agent) -i curl wget<br>block if bad_agent<br><span class="hljs-meta prompt_">#</span><span class="language-bash">匹配用户请求报文中host的开头是不是www</span><br>acl short_form hdr_beg(host)       www<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">URL内容匹配</span><br>完整的URL为&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;&lt;frag&gt;<br>base : string	#返回第一个主机头和请求的路径部分的连接，该请求从主机名开始，并在问号之前结束  即是&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">以下为base匹配方式</span><br> base     : 准确匹配<br> base_beg : prefix match<br> base_dir : subdir match<br> base_dom : domain match<br> base_end : suffix match<br> base_len : length match<br> base_reg : regex match<br> base_sub : substring match<br> <br>path : string	#提取请求的URL路径，该路径从第一个斜杠开始，并在问号之前结束（无主机部分）  即是&lt;path&gt;;&lt;params&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">以下为path匹配方式</span><br> path     : exact string match<br> path_beg : prefix match  #请求的URL开头，如/static、/images、/img、/css<br> path_end : suffix match  #请求的URL中资源的结尾，如 .gif .png .css .js .jpg <br>.jpeg<br> path_dom : domain match<br> path_dir : subdir match<br> path_len : length match<br> path_reg : regex match<br> path_sub : substring match<br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：匹配部分资源</span><br> path_beg -i /haproxy-status/ 		#路径开头<br> path_end .jpg .jpeg .png .gif 		#图片后缀<br> path_reg ^/images.*\.jpeg$ 	#正则匹配<br> path_sub image  		#路径包含image<br> <br>url : string	#提取请求中的整个URL。一个典型的应用是具有预取能力的缓存，以及需要从数据库聚合多个信息并将它们保存在缓存中的网页门户入口，推荐使用path<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">也可以匹配http协议，如只允许get和<span class="hljs-built_in">head</span></span><br>acl valid_method method GET HEAD<br>http-request deny if ! valid_method<br></code></pre></td></tr></table></figure>

<h3 id="根据域名调度"><a href="#根据域名调度" class="headerlink" title="根据域名调度"></a>根据域名调度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">前端</span><br>frontend magedu_http_port<br> bind 10.0.0.7:80<br> mode http<br> balance roundrobin		#采用roundrobin方便测试时观察<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设定acl</span><br> acl pc_domain hdr_dom(host)      -i www.magedu.org<br> acl mobile_domain hdr_dom(host)   -i mobile.magedu.org<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">针对列表选择主机，如pc域名调度给pc网页服务器，移动端域名调度mobile网页服务器</span><br> use_backend pc_hosts   if   pc_domain<br> use_backend mobile_hosts     if   mobile_domain<br> default_backend pc_hosts   #所有ACL都不匹配,则使用的默认backend<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">后端服务器</span><br>backend mobile_hosts<br> mode http<br> server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5<br> server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5<br>backend pc_hosts<br> mode http<br> server web2 10.0.0.37:80 check inter 2000 fall 3 rise 5<br> server web2 10.0.0.47:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="根据文件名后缀调度"><a href="#根据文件名后缀调度" class="headerlink" title="根据文件名后缀调度"></a>根据文件名后缀调度</h3><p>​		相当于实现了动静分离</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">前端</span><br>frontend magedu_http_port<br> bind 10.0.0.7:80<br> mode http<br> balance roundrobin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">定义acl</span><br> acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html  <br> acl acl_php   path_end -i .php<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">选择后端主机群</span><br> use_backend mobile_hosts if acl_static<br> use_backend app_hosts if acl_php<br> default_backend pc_hosts<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">同一主机可在多个后端集群中</span><br>backend mobile_hosts<br> mode http<br> server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5<br> server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5<br>backend pc_hosts<br> mode http<br> server web2 10.0.0.37:80 check inter 2000 fall 3 rise 5<br> server web1 10.0.0.47:80 check inter 2000 fall 3 rise 5<br>backend app_hosts<br> mode http<br> server web1 10.0.0.47:80 check inter 2000 fall 3 rise 5<br> server web2 10.0.0.57:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="根据访问路径调度"><a href="#根据访问路径调度" class="headerlink" title="根据访问路径调度"></a>根据访问路径调度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">前端</span><br>frontend magedu_http_port<br> bind 10.0.0.7:80<br> mode http<br> balance roundrobin<br><span class="hljs-meta prompt_">#</span><span class="language-bash">定义acl</span><br> acl acl_static path_beg  -i /static /images /javascript        #基于路径的ACL<br> acl acl_static path_end  -i .jpg .jpeg .png .gif .css .js .html .htm  <br><span class="hljs-meta prompt_">#</span><span class="language-bash">acl同名为或关系</span><br> acl acl_app path_beg  -i /api<br><br> use_backend static_hosts if acl_static<br> use_backend app_hosts   if acl_app<br> default_backend app_hosts<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">后端</span><br>backend static_hosts<br> mode http<br> server web1 10.0.0.17 check inter 2000 fall 3 rise 5<br>backend app_hosts<br> mode http<br> server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>

<h3 id="ACL四层访问控制"><a href="#ACL四层访问控制" class="headerlink" title="ACL四层访问控制"></a>ACL四层访问控制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">拒绝某网段或IP的tcp请求</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">前端</span><br>frontend web_host<br> bind 10.0.0.7:80<br> mode http<br> balance roundrobin<br> log global<br> option httplog<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">acl定义</span> <br> acl static_path path_beg  -i /static /images /javascript<br> acl invalid_src src 192.168.1.0/24 10.0.0.8<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">tcp访问控制</span><br>use_backend static_path_host if HTTP_1.1 TRUE static_path<br>tcp-request connection reject if invalid_src<br>default_backend default_web<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">后端</span><br>backend static_path_host<br> mode http<br> server web1 10.0.0.27 check inter 2000 fall 3 rise 5<br>backend default_web<br> mode http<br> server web1 10.0.0.37:80 check inter 2000 fall 3 rise 5<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/">反向代理</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/HAproxy/">HAproxy</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/10/Tomcat%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Tomcat配置总结</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/09/Keepalived%E7%9A%84%E9%85%8D%E7%BD%AE%E5%92%8C%E5%BA%94%E7%94%A8/">
                        <span class="hidden-mobile">Keepalived的配置和应用</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
